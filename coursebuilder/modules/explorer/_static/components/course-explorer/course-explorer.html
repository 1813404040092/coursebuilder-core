<link rel="import" href="/static/polymer-1.2.0/polymer/polymer.html">
<link rel="import" href="/static/polymer-1.2.0/iron-ajax/iron-ajax.html" />
<link rel="import" href="/static/polymer-1.2.0/paper-spinner/paper-spinner.html" />
<link rel="import" href="/modules/explorer/_static/components/utility/unsafe-html.html">
<link rel="import" href="/modules/explorer/_static/components/utility/floating-sidebar.html">
<link rel="import" href="/modules/explorer/_static/components/course-cards/course-card-grouper.html">
<link rel="import" href="/modules/explorer/_static/components/filter-sidebar/filter-sidebar.html">
<link rel="import" href="/modules/explorer/_static/components/top-bar/top-bar.html">

<dom-module id="course-explorer">
  <template>
      <!-- NavBar -->
      <!-- Mobile Nav -->
      <nav class="home-mobile-nav">
          <div class="nav-wrapper">
              <ul class="side-nav" id="mobile-demo">
                  <li><a href="#!home" class="mobile-nav-logo"><img
                          src="/modules/explorer/_static/images/navbar-logo.png" alt="logo"></a></li>

                  <li>
                      <div class="divider"></div>
                  </li>

                  <li>
                      <a href="#!explorer" class="waves-effect waves-light btn-large">Start Learning</a>
                  </li>
                  <li><a href="#!"><i class="material-icons">account_circle</i>Sign in</a></li>
                  <li><a href="#!home"><i class="material-icons">home</i>Home</a></li>
                  <li><a href="#!explorer"><i class="material-icons">library_books</i>Topic Library</a></li>
                  <li><a href="#!"><i class="material-icons">school</i>Certification</a></li>

                  <li>
                      <div class="divider"></div>
                  </li>

                  <li><a href="#!"><i class="material-icons">work</i>Tools</a></li>
                  <li><a href="#!"><i class="material-icons">insert_invitation</i>Events</a></li>
                  <li><a href="#!"><i class="material-icons">people</i>Partners</a></li>
                  <li><a href="#!"><i class="material-icons">help</i>Help & FAQs</a></li>
                  <li><a href="#!"><i class="material-icons">chat_bubble</i>Feedback</a></li>

                  <li>
                      <div class="divider"></div>
                  </li>

                  <li><a href="#!"><i class="material-icons">thumb_up</i>Blog</a></li>
                  <template is="dom-if" if="[[!currentUser.loggedIn]]">
                        <li><a href="[[currentUser.loginUrl]]" class="waves-effect waves-light btn-large">Sign in</a></li>
                  </template>

                  <template is="dom-if" if="[[currentUser.loggedIn]]">
                      <li>
                          <div class="divider"></div>
                      </li>
                      <template is="dom-if" if="[[currentUser.canViewDashboard]]">
                          <li><a href="/modules/admin"><i class="material-icons">dashboard</i>Dashboard</a></li>
                      </template>
                      <li><a href="[[currentUser.logoutUrl]]"><i class="material-icons">exit_to_app</i>Logout</a></li>
                  </template>
              </ul>
          </div>
      </nav>

      <!-- Desktop NavBAr -->
      <div class="navbar-fixed">
          <nav class="nav-extended">
              <div class="nav-wrapper pad-5">
                  <a href="#!home" class="brand-logo"><img src="/modules/explorer/_static/images/navbar-logo.png"
                                                           alt="logo"></a>
              </div>

              <div class="nav-wrapper home-main-menu pad-5">
                  <a href="#" data-activates="mobile-demo" class="button-collapse"><i
                          class="material-icons">menu</i></a>
                  <ul class="left hide-on-med-and-down">
                      <li><a href="#!home">Home</a></li>
                      <li><a href="#!explorer">Topic Library</a></li>
                      <li><a href="#!">Certification</a></li>
                      <li><a href="#!">Events</a></li>
                      <li><a href="#!">Partners</a></li>
                      <!-- Dropdown Trigger -->
                      <li><a class="dropdown-button" href="#!" data-activates="dropdown1">More<i
                              class="material-icons right">arrow_drop_down</i></a>
                      </li>
                  </ul>

                  <template is="dom-if" if="[[!currentUser.loggedIn]]">
                      <ul class="right hide-on-med-and-down sign-in-nav">
                          <li><a class="sign-in-link" href="[[currentUser.loginUrl]]">SIGN IN</a></li>
                          <li><a href="[[currentUser.loginUrl]]" class="waves-effect waves-light btn">Start Learning</a></li>
                      </ul>
                  </template>

              </div>
          </nav>
      </div>
      <!--  Dropdown(s) -->
      <ul id='dropdown1' class='dropdown-content'>
          <li><a href="#!">First</a></li>
          <li><a href="#!">Second</a></li>
          <li><a href="#!">Third</a></li>
          <li><a href="#!">Fourth</a></li>
          <li class="divider"></li>
          <template is="dom-if" if="[[currentUser.loggedIn]]">
              <template is="dom-if" if="[[currentUser.canViewDashboard]]">
                  <li><a href="/modules/admin">Dashboard</a></li>
              </template>
              <li><a href="[[currentUser.logoutUrl]]">Logout</a></li>
          </template>
      </ul>

      <div id="homepage">
          <!--  Hero Banner  -->
          <div class="hero-banner">
              <div class="hero-banner-content">
                  <h1 class="intro-title">Boost your digital knowledge</h1>
                  <p>Free courses on everything from search to social media, to help you grow your business or
                      career.</p>
                  <a href="#!" class="waves-effect waves-light btn-large">Keep Learning</a>
              </div>

          </div>

          <!--  Mission  -->
          <div class="section mission">
              <div class="mission-inner">
                  <h2>What is The Digital Garage?</h2>
                  <p>Free tutorials from Google on everything from your website to online marketing and beyond. Choose
                      the
                      topics you want to learn, or complete the whole online course for a certification from Google and
                      IAB
                      Europe.</p>
              </div>
          </div>

          <!--  Awards  -->
          <div class="section awards">
              <div class="carousel-section-wrapper">
                  <h2 class="section-label">An award winning platform</h2>
                  <div class="owl-carousel owl-theme awards-carousel">
                      <div class="item">
                          <img src="/modules/explorer/_static/images/award1.png" alt="">
                          <p>
                              European Commission <br> Digital Skills Award 2016
                          </p>
                      </div>
                      <div class="item">
                          <img src="/modules/explorer/_static/images/award2.png" alt="">
                          <p>
                              European Commission <br> Digital Skills Award 2016
                          </p>
                      </div>
                      <div class="item">
                          <img src="/modules/explorer/_static/images/award3.png" alt="">
                          <p>
                              European Commission <br> Digital Skills Award 2016
                          </p>
                      </div>
                      <div class="item">
                          <img src="/modules/explorer/_static/images/award1.png" alt="">
                          <p>
                              European Commission <br> Digital Skills Award 2016
                          </p>
                      </div>
                      <div class="item">
                          <img src="/modules/explorer/_static/images/award3.png" alt="">
                          <p>
                              European Commission <br> Digital Skills Award 2016
                          </p>
                      </div>
                      <div class="item">
                          <img src="/modules/explorer/_static/images/award2.png" alt="">
                          <p>
                              European Commission <br> Digital Skills Award 2016
                          </p>
                      </div>
                  </div>
              </div>
          </div>

          <!--  How it works  -->
          <div class="section how-it-works">
              <div class="carousel-section-wrapper">
                  <h2 class="section-label">How It Works</h2>

                  <div class="owl-carousel owl-theme how-carousel">
                      <div class="item">
                          <div class="row">
                              <div class="col m6 s12 how-it-works-img">
                                  <img src="/modules/explorer/_static/images/how4.png" alt="">
                              </div>
                              <div class="col m6 s12">
                                  <h3 class="how-it-works-heading">Set your goals</h3>
                                  <p class="how-it-works-text">Create a learning plan that's right for you-whether you
                                      want to
                                      sell online, reach more people on social media, or simply get your work
                                      noticed.</p>
                              </div>
                          </div>
                      </div>
                      <div class="item">
                          <div class="row">
                              <div class="col m6 s12 how-it-works-img">
                                  <img src="/modules/explorer/_static/images/how1.png" alt="">
                              </div>
                              <div class="col m6 s12">
                                  <h3 class="how-it-works-heading">Set your goals</h3>
                                  <p class="how-it-works-text">Create a learning plan that's right for you-whether you
                                      want to
                                      sell online, reach more people on social media, or simply get your work
                                      noticed.</p>
                              </div>
                          </div>
                      </div>
                      <div class="item">
                          <div class="row">
                              <div class="col m6 s12 how-it-works-img">
                                  <img src="/modules/explorer/_static/images/how2.png" alt="">
                              </div>
                              <div class="col m6 s12">
                                  <h3 class="how-it-works-heading">Set your goals</h3>
                                  <p class="how-it-works-text">Create a learning plan that's right for you-whether you
                                      want to
                                      sell online, reach more people on social media, or simply get your work
                                      noticed.</p>
                              </div>
                          </div>
                      </div>
                      <div class="item">
                          <div class="row">
                              <div class="col m6 s12 how-it-works-img">
                                  <img src="/modules/explorer/_static/images/how3.png" alt="">
                              </div>
                              <div class="col m6 s12">
                                  <h3 class="how-it-works-heading">Set your goals</h3>
                                  <p class="how-it-works-text">Create a learning plan that's right for you-whether you
                                      want to
                                      sell online, reach more people on social media, or simply get your work
                                      noticed.</p>
                              </div>
                          </div>
                      </div>
                      <div class="item">
                          <div class="row">
                              <div class="col m6 s12 how-it-works-img">
                                  <img src="/modules/explorer/_static/images/how2.png" alt="">
                              </div>
                              <div class="col m6 s12">
                                  <h3 class="how-it-works-heading">Set your goals</h3>
                                  <p class="how-it-works-text">Create a learning plan that's right for you-whether you
                                      want to
                                      sell online, reach more people on social media, or simply get your work
                                      noticed.</p>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </div>


          <!--  Questions  -->
          <div class="section question-cards">
              <div class="simple-container">
                  <div class="card">
                      <div class="question-card-div">
                          <div class="question-card-media">
                              <div class="responsive-media-wrapper">
                                  <iframe allowfullscreen="" width="100%" height="100%" frameborder="0"
                                          ng-src="https://www.youtube.com/embed/YXrmBpz_WSk?rel=0&amp;showinfo=0"
                                          src="https://www.youtube.com/embed/YXrmBpz_WSk?rel=0&amp;showinfo=0">
                                  </iframe>
                              </div>
                          </div>

                          <div class="question-card-text">
                              <h2>Why does it matter?</h2>
                              <p>Thousands of people have already taken part and learned new skills with The Digital
                                  Garage.
                                  Hear from a few of them on how digital has made a difference to their businesses and
                                  lives.</p>
                          </div>
                      </div>

                  </div>

                  <div class="card">
                      <div class="question-card-div flex-reverse">
                          <div class="question-card-media">
                              <img src="/modules/explorer/_static/images/questioncard-img.jpg" alt=""
                                   aria-hidden="true">
                          </div>

                          <div class="question-card-text">
                              <h2>Is your site mobile-friendly?</h2>
                              <p>To turn your visitors into customers, your site needs to work well across devices -
                                  from
                                  smartphones to desktop computers. See how your site scores on mobile-friendliness and
                                  speed
                                  - and what you can improve.</p>
                              <a href="https://testmysite.withgoogle.com/intl/en-gb?utm_source=dwhp&amp;utm_medium=referral&amp;utm_campaign=dwhp_gb"
                                 aria-label="Test My SIte">Test My SIte</a>
                          </div>
                      </div>

                  </div>
              </div>


          </div>

          <!--  Testimonials  -->
          <div class="testimonials section">
              <h2 class="section-label">Testimonials</h2>
              <div>
                  <div class="card-tabs">
                      <div class="row">
                          <div class="testimonials-card-tabs">
                              <ul class="tabs tabs-fixed-width">
                                  <li class="tab"><a class="active" href="#testimonial1">adrian</a></li>
                                  <li class="tab"><a href="#testimonial2">rachal</a></li>
                                  <li class="tab"><a href="#testimonial3">mike</a></li>
                              </ul>
                          </div>
                      </div>
                  </div>
                  <div class="card-content grey lighten-4">
                      <div id="testimonial1" class="testimonial-div">
                          <div class="testimonial-card">
                              <h3>Words to live by</h3>
                              <p>Adrian Simpson set up a basic website for his new speechwriting business and began
                                  advertising online through search.
                                  <br>
                                  <br>Within 31 days, he'd sold 31 speeches.</p>
                          </div>
                          <img src="/modules/explorer/_static/images/testimonial1.jpg" alt="testimonial image">
                      </div>
                      <div id="testimonial2" class="testimonial-div">
                          <div class="testimonial-card">
                              <h3>Words to live by</h3>
                              <p>Adrian Simpson set up a basic website for his new speechwriting business and began
                                  advertising online through search.
                                  <br>
                                  <br>Within 31 days, he'd sold 31 speeches.</p>
                          </div>
                          <img src="/modules/explorer/_static/images/testimonial2.jpg" alt="testimonial image">
                      </div>
                      <div id="testimonial3" class="testimonial-div">
                          <div class="testimonial-card">
                              <h3>Words to live by</h3>
                              <p>Adrian Simpson set up a basic website for his new speechwriting business and began
                                  advertising online through search.
                                  <br>
                                  <br>Within 31 days, he'd sold 31 speeches.</p>
                          </div>
                          <img src="/modules/explorer/_static/images/testimonial3.jpg" alt="testimonial image">
                      </div>
                  </div>
              </div>
          </div>

          <!--  Continue Learning -->
          <a href="#!">
              <div class="continue-learning">
                  <p class="tiny-text">Continue learining</p>

                  <h3>View your Dashboard <i class="material-icons">arrow_forward</i></h3>
              </div>
          </a>
      </div>

      <div id="explorer">
          <hr>

          <style>
              #top-content {
                  background: white;
                  border-bottom: 1px solid rgb(229, 229, 229);
              }

              #content {
                  flex: 1;
                  padding-left: 48px;
                  padding-top: 32px;
                  position: relative;
              }

              #main {
                  display: flex;
              }

              paper-spinner {
                  position: absolute;
                  left: 32px;
                  top: 32px;
              }
          </style>

          <iron-ajax
                  auto url="/modules/gql/query"
                  params="[[_getCoursesQuery()]]"
                  handle-as="json"
                  json-prefix=")]}'"
                  on-response="_onCoursesResponse"
          ></iron-ajax>

          <iron-ajax
                  auto url="/modules/gql/query"
                  params="[[_getBasicQuery()]]"
                  handle-as="json"
                  json-prefix=")]}'"
                  on-response="_onBasicResponse"
          ></iron-ajax>

          <div id="top-content">
              <top-bar
                      site="[[site]]"
                      current-user="[[currentUser]]"
              ></top-bar>

              <unsafe-html
                      html="[[site.courseExplorer.extraContent]]"
              ></unsafe-html>
          </div>

          <div id="main">
              <floating-sidebar>
                  <filter-sidebar
                          filter-options="{{ filterOptions }}"
                          categories="[[categories]]"
                  ></filter-sidebar>
              </floating-sidebar>

              <div id="content">
                  <paper-spinner active="{{!coursesLoaded}}"></paper-spinner>
                  <course-card-grouper
                          id="grouper"
                          courses="[[_filter(courses.edges, filterOptions.*)]]"
                  ></course-card-grouper>
              </div>
          </div>
      </div>


  </template>
  <script>

    var _textMatch = function(needle, haystack) {
      return haystack.toUpperCase().indexOf(needle.toUpperCase()) != -1;
    }

    Polymer({
      is: 'course-explorer',
      properties: {
        filterOptions: {
          type: Object,
          value: {
            filter: '',
            category: 'all',
          },
          notify: true,
        },
        courses: {
          type: Array,
        },
        currentUser: {
          type: Object,
        },
        site: {
          type: Object,
        },
        categories: {
          type: Array,
          value: [],
        },
        coursesLoaded: {
          type: Boolean,
          value: false,
        }
      },

      _getBasicQuery: function() {
        return {q:
            '{site {title, logo {url, altText},' +
            '  courseExplorer {extraContent}}, ' +
            'currentUser {' +
            '  email, loggedIn, canViewDashboard, loginUrl (destUrl: "/"),' +
            '  logoutUrl (destUrl: "/")}}'
        }
      },

      _onBasicResponse: function(event) {
        this.set('site', event.detail.response.data.site);
          console.log(event.detail.response.data.currentUser)
        this.set('currentUser', event.detail.response.data.currentUser);
      },

      _getCoursesQuery: function() {
        return {
          q: '{allCourses {edges {node {' +
             '  id, title, url, abstract, instructorDetails,' +
             '  enrollment {enrolled}, openForRegistration, showInExplorer,' +
             '  startDate, endDate, estimatedWorkload, category {name} }}}}',
          expanded_gcb_tags: 'gcb-markdown'
        };
      },

      _onCoursesResponse: function(event) {
        this.set('courses', event.detail.response.data.allCourses);
        this.set(
          'filterOptions.status', this._enrolledInAny() ? 'enrolled' : 'all');
        this.set('categories', this._getCategories().sort());
        this.set('coursesLoaded', true);
      },

      _enrolledInAny: function() {
        return this.courses.edges.some(function(course) {
          return course.node.enrollment.enrolled;
        })
      },

      _getCategories: function() {
        var categories = []
        this.courses.edges.forEach(function(edge) {
          if (
              edge.node.category &&
              edge.node.category.name &&
              categories.indexOf(edge.node.category.name) == -1 ) {
            categories.push(edge.node.category.name);
          }
        })
        return categories;
      },

      _filter: function(courses, filterOptionsPath) {
        var filterOptions = filterOptionsPath.base;
        var that = this;
        return courses.filter(function(course) {
          if (!course.node.showInExplorer) {
            return false;
          }

          // Filter by status

          // A course is "completed" from the point of view of the offering
          // institution if it is visible but registration is no longer allowed
          // (it it's now "over").
          if (
              filterOptions.status == 'enrolled' &&
              !course.node.enrollment.enrolled) {
            return false;
          } else if (
              filterOptions.status == 'ended' &&
              course.node.openForRegistration) {
            return false;
          }

          // Filter by category
          if (
              filterOptions.category != 'all' && (
              !course.node.category ||
              !course.node.category.name ||
              course.node.category.name != filterOptions.category)) {
            return false;
          }

          // Filter by text
          if (filterOptions.filter) {
            var text_fields = [
              course.node.title,
              course.node.abstract,
              course.node.instructorDetails,
            ]
            function match(field) {
              return field && _textMatch(filterOptions.filter, field);
            }
            if (!text_fields.some(match)) {
              return false;
            }
          }

          return true;
        })
      },
    })
  </script>
</dom-module>
